(function(){if(typeof document>"u"||"adoptedStyleSheets"in document)return;var S="ShadyCSS"in window&&!ShadyCSS.nativeShadow,n=document.implementation.createHTMLDocument(""),o=new WeakMap,r=typeof DOMException=="object"?Error:DOMException,a=Object.defineProperty,h=Array.prototype.forEach,c=/@import.+?;?$/gm;function l(t){var e=t.replace(c,"");return e!==t&&console.warn("@import rules are not allowed here. See https://github.com/WICG/construct-stylesheets/issues/119#issuecomment-588352418"),e.trim()}function s(t){return"isConnected"in t?t.isConnected:document.contains(t)}function p(t){return t.filter(function(e,i){return t.indexOf(e)===i})}function d(t,e){return t.filter(function(i){return e.indexOf(i)===-1})}function f(t){t.parentNode.removeChild(t)}function b(t){return t.shadowRoot||o.get(t)}var L=["addRule","deleteRule","insertRule","removeRule"],$=CSSStyleSheet,v=$.prototype;v.replace=function(){return Promise.reject(new r("Can't call replace on non-constructed CSSStyleSheets."))},v.replaceSync=function(){throw new r("Failed to execute 'replaceSync' on 'CSSStyleSheet': Can't call replaceSync on non-constructed CSSStyleSheets.")};function O(t){return typeof t=="object"?C.isPrototypeOf(t)||v.isPrototypeOf(t):!1}function D(t){return typeof t=="object"?v.isPrototypeOf(t):!1}var m=new WeakMap,w=new WeakMap,R=new WeakMap,A=new WeakMap;function J(t,e){var i=document.createElement("style");return R.get(t).set(e,i),w.get(t).push(e),i}function E(t,e){return R.get(t).get(e)}function U(t,e){R.get(t).delete(e),w.set(t,w.get(t).filter(function(i){return i!==e}))}function q(t,e){requestAnimationFrame(function(){e.textContent=m.get(t).textContent,A.get(t).forEach(function(i){return e.sheet[i.method].apply(e.sheet,i.args)})})}function T(t){if(!m.has(t))throw new TypeError("Illegal invocation")}function P(){var t=this,e=document.createElement("style");n.body.appendChild(e),m.set(t,e),w.set(t,[]),R.set(t,new WeakMap),A.set(t,[])}var C=P.prototype;C.replace=function(e){try{return this.replaceSync(e),Promise.resolve(this)}catch(i){return Promise.reject(i)}},C.replaceSync=function(e){if(T(this),typeof e=="string"){var i=this;m.get(i).textContent=l(e),A.set(i,[]),w.get(i).forEach(function(g){g.isConnected()&&q(i,E(i,g))})}},a(C,"cssRules",{configurable:!0,enumerable:!0,get:function(){return T(this),m.get(this).sheet.cssRules}}),a(C,"media",{configurable:!0,enumerable:!0,get:function(){return T(this),m.get(this).sheet.media}}),L.forEach(function(t){C[t]=function(){var e=this;T(e);var i=arguments;A.get(e).push({method:t,args:i}),w.get(e).forEach(function(y){if(y.isConnected()){var u=E(e,y).sheet;u[t].apply(u,i)}});var g=m.get(e).sheet;return g[t].apply(g,i)}}),a(P,Symbol.hasInstance,{configurable:!0,value:O});var B={childList:!0,subtree:!0},H=new WeakMap;function x(t){var e=H.get(t);return e||(e=new Z(t),H.set(t,e)),e}function z(t){a(t.prototype,"adoptedStyleSheets",{configurable:!0,enumerable:!0,get:function(){return x(this).sheets},set:function(e){x(this).update(e)}})}function j(t,e){for(var i=document.createNodeIterator(t,NodeFilter.SHOW_ELEMENT,function(y){return b(y)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT},null,!1),g=void 0;g=i.nextNode();)e(b(g))}var F=new WeakMap,k=new WeakMap,N=new WeakMap;function K(t,e){return e instanceof HTMLStyleElement&&k.get(t).some(function(i){return E(i,t)})}function V(t){var e=F.get(t);return e instanceof Document?e.body:e}function I(t){var e=document.createDocumentFragment(),i=k.get(t),g=N.get(t),y=V(t);g.disconnect(),i.forEach(function(u){e.appendChild(E(u,t)||J(u,t))}),y.insertBefore(e,null),g.observe(y,B),i.forEach(function(u){q(u,E(u,t))})}function Z(t){var e=this;e.sheets=[],F.set(e,t),k.set(e,[]),N.set(e,new MutationObserver(function(i,g){if(!document){g.disconnect();return}i.forEach(function(y){S||h.call(y.addedNodes,function(u){u instanceof Element&&j(u,function(M){x(M).connect()})}),h.call(y.removedNodes,function(u){u instanceof Element&&(K(e,u)&&I(e),S||j(u,function(M){x(M).disconnect()}))})})}))}if(Z.prototype={isConnected:function(){var t=F.get(this);return t instanceof Document?t.readyState!=="loading":s(t.host)},connect:function(){var t=V(this);N.get(this).observe(t,B),k.get(this).length>0&&I(this),j(t,function(e){x(e).connect()})},disconnect:function(){N.get(this).disconnect()},update:function(t){var e=this,i=F.get(e)===document?"Document":"ShadowRoot";if(!Array.isArray(t))throw new TypeError("Failed to set the 'adoptedStyleSheets' property on "+i+": Iterator getter is not callable.");if(!t.every(O))throw new TypeError("Failed to set the 'adoptedStyleSheets' property on "+i+": Failed to convert value to 'CSSStyleSheet'");if(t.some(D))throw new TypeError("Failed to set the 'adoptedStyleSheets' property on "+i+": Can't adopt non-constructed stylesheets");e.sheets=t;var g=k.get(e),y=p(t),u=d(g,y);u.forEach(function(M){f(E(M,e)),U(M,e)}),k.set(e,y),e.isConnected()&&y.length>0&&I(e)}},window.CSSStyleSheet=P,z(Document),"ShadowRoot"in window){z(ShadowRoot);var _=Element.prototype,Q=_.attachShadow;_.attachShadow=function(e){var i=Q.call(this,e);return e.mode==="closed"&&o.set(this,i),i}}var W=x(document);W.isConnected()?W.connect():document.addEventListener("DOMContentLoaded",W.connect.bind(W))})();const G=S=>S?.split(/[,;\s]/)?.filter(n=>n)?.map(n=>n.split("=").map(o=>o.trim())),X=(S,n)=>{if(S.documentElement.localName==="svg"){const[,,a,h]=S.documentElement.getAttribute("viewBox")?.split(/\s/)??[];return{width:a,height:h}}const o=G(S.querySelector('meta[name="viewport"]')?.getAttribute("content"));if(o)return Object.fromEntries(o);if(typeof n=="string")return G(n);if(n)return n;const r=S.querySelector("img");return r?{width:r.naturalWidth,height:r.naturalHeight}:(console.warn(new Error("Missing viewport properties")),{width:1e3,height:2e3})};class Y extends HTMLElement{static observedAttributes=["zoom"];#c=this.attachShadow({mode:"closed"});#u=new ResizeObserver(()=>this.#a());#r;#i=-1;defaultViewport;spread;#h=!1;#e;#n;#t;#o;#s;constructor(){super();const n=new CSSStyleSheet;this.#c.adoptedStyleSheets=[n],n.replaceSync(`:host {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: auto;
        }`),this.#u.observe(this)}attributeChangedCallback(n,o,r){switch(n){case"zoom":this.#s=r!=="fit-width"&&r!=="fit-page"?parseFloat(r):r,this.#a();break}}async#l({index:n,src:o}){const r=typeof o=="string",a=r?o:o?.src,h=r?null:o?.onZoom,c=document.createElement("div"),l=document.createElement("iframe");return c.append(l),Object.assign(l.style,{border:"0",display:"none",overflow:"hidden"}),l.setAttribute("sandbox","allow-same-origin allow-scripts"),l.setAttribute("scrolling","no"),l.setAttribute("part","filter"),this.#c.append(c),a?new Promise(s=>{l.addEventListener("load",()=>{const p=l.contentDocument;this.dispatchEvent(new CustomEvent("load",{detail:{doc:p,index:n}}));const{width:d,height:f}=X(p,this.defaultViewport);s({element:c,iframe:l,width:parseFloat(d),height:parseFloat(f),onZoom:h})},{once:!0}),l.src=a}):{blank:!0,element:c,iframe:l}}#a(n=this.#o){if(!n)return;const o=this.#e??{},r=this.#t??this.#n,a=n==="left"?o:r,{width:h,height:c}=this.getBoundingClientRect(),l=this.spread!=="both"&&this.spread!=="portrait"&&c>h;this.#h=l;const s=o.width??r.width,p=o.height??r.height,d=typeof this.#s=="number"&&!isNaN(this.#s)?this.#s:this.#s==="fit-width"?l||this.#t?h/(a.width??s):h/((o.width??s)+(r.width??s)):l||this.#t?Math.min(h/(a.width??s),c/(a.height??p)):Math.min(h/((o.width??s)+(r.width??s)),c/Math.max(o.height??p,r.height??p)),f=b=>{let{element:L,iframe:$,width:v,height:O,blank:D,onZoom:m}=b;m&&m({doc:b.iframe.contentDocument,scale:d});const w=m?d:1;Object.assign($.style,{width:`${v*w}px`,height:`${O*w}px`,transform:m?"none":`scale(${d})`,transformOrigin:"top left",display:D?"none":"block"}),Object.assign(L.style,{width:`${(v??s)*d}px`,height:`${(O??p)*d}px`,overflow:"hidden",display:"block",flexShrink:"0",marginBlock:"auto"}),l&&b!==a&&(L.style.display="none")};this.#t?f(this.#t):(f(o),f(r))}async#f({left:n,right:o,center:r,side:a}){this.#c.replaceChildren(),this.#e=null,this.#n=null,this.#t=null,r?(this.#t=await this.#l(r),this.#o="center",this.#a()):(this.#e=await this.#l(n),this.#n=await this.#l(o),this.#o=this.#e.blank?"right":this.#n.blank?"left":a,this.#a())}#p(){if(!(this.#t||this.#e?.blank)&&this.#h&&this.#e?.element?.style?.display==="none")return this.#n.element.style.display="none",this.#e.element.style.display="block",this.#o="left",!0}#g(){if(!(this.#t||this.#n?.blank)&&this.#h&&this.#n?.element?.style?.display==="none")return this.#e.element.style.display="none",this.#n.element.style.display="block",this.#o="right",!0}open(n){this.book=n;const{rendition:o}=n;this.spread=o?.spread,this.defaultViewport=o?.viewport;const r=n.dir==="rtl",a=!r;this.rtl=r,o?.spread==="none"?this.#r=n.sections.map(h=>({center:h})):this.#r=n.sections.reduce((h,c,l)=>{const s=h[h.length-1],{pageSpread:p}=c,d=()=>{const f={};return h.push(f),f};if(p==="center"){const f=s.left||s.right?d():s;f.center=c}else if(p==="left"){const f=s.center||s.left||a&&l?d():s;f.left=c}else if(p==="right"){const f=s.center||s.right||r&&l?d():s;f.right=c}else a?s.center||s.right?d().left=c:s.left||!l?s.right=c:s.left=c:s.center||s.left?d().right=c:s.right||!l?s.left=c:s.right=c;return h},[{}])}get index(){const n=this.#r[this.#i],o=n?.center??(this.side==="left"?n.left??n.right:n.right??n.left);return this.book.sections.indexOf(o)}#d(n){this.dispatchEvent(new CustomEvent("relocate",{detail:{reason:n,range:null,index:this.index,fraction:0,size:1}}))}getSpreadOf(n){const o=this.#r;for(let r=0;r<o.length;r++){const{left:a,right:h,center:c}=o[r];if(a===n)return{index:r,side:"left"};if(h===n)return{index:r,side:"right"};if(c===n)return{index:r,side:"center"}}}async goToSpread(n,o,r){if(n<0||n>this.#r.length-1)return;if(n===this.#i){this.#a(o);return}this.#i=n;const a=this.#r[n];if(a.center){const h=this.book.sections.indexOf(a.center),c=await a.center?.load?.();await this.#f({center:{index:h,src:c}})}else{const h=this.book.sections.indexOf(a.left),c=this.book.sections.indexOf(a.right),l=await a.left?.load?.(),s=await a.right?.load?.(),p={index:h,src:l},d={index:c,src:s};await this.#f({left:p,right:d,side:o})}this.#d(r)}async select(n){await this.goTo(n)}async goTo(n){const{book:o}=this,r=await n,a=o.sections[r.index];if(!a)return;const{index:h,side:c}=this.getSpreadOf(a);await this.goToSpread(h,c)}async next(){if(this.rtl?this.#p():this.#g())this.#d("page");else return this.goToSpread(this.#i+1,this.rtl?"right":"left","page")}async prev(){if(this.rtl?this.#g():this.#p())this.#d("page");else return this.goToSpread(this.#i-1,this.rtl?"left":"right","page")}getContents(){return Array.from(this.#c.querySelectorAll("iframe"),n=>({doc:n.contentDocument}))}destroy(){this.#u.unobserve(this)}}customElements.define("foliate-fxl",Y);export{Y as FixedLayout};

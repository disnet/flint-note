const h={XML:"http://www.w3.org/XML/1998/namespace",SSML:"http://www.w3.org/2001/10/synthesis"},E=new Set(["article","aside","audio","blockquote","caption","details","dialog","div","dl","dt","dd","figure","footer","form","figcaption","h1","h2","h3","h4","h5","h6","header","hgroup","hr","li","main","math","nav","ol","p","pre","section","tr"]),M=i=>{const t=i.lang||i?.getAttributeNS?.(h.XML,"lang");return t||(i.parentElement?M(i.parentElement):null)},N=i=>{const t=i?.getAttributeNS?.(h.XML,"lang");return t||(i.parentElement?N(i.parentElement):null)},A=(i="en",t="word")=>{const e=new Intl.Segmenter(i,{granularity:t}),n=t==="word";return function*(s,o){const m=s.join("").replace(/\r\n/g,"  ").replace(/\r/g," ").replace(/\n/g," ");let f=0,r=-1,l=0;const u=Array.from(e.segment(m)),g=[];for(let a=0;a<u.length;a++){const c=u[a],S=u[a+1],p=c.segment.trim(),b=S?.segment?.trim(),d=/(?:^|\s)([A-Z][a-z]{1,5})\.$/.test(p),x=/^[A-Z]/.test(b||"");if(d&&x){const w={index:c.index,segment:c.segment+(S?.segment||""),isWordLike:!0};g.push(w),a++}else g.push(c)}for(const{index:a,segment:c,isWordLike:S}of g){if(n&&!S)continue;for(;l<=a;)l+=s[++r].length;const p=r,b=a-(l-s[r].length),d=a+c.length-1;if(d<m.length)for(;l<=d;)l+=s[++r].length;const x=r,w=d-(l-s[r].length)+1;yield[(f++).toString(),o(p,b,x,w)]}}},k=(i,t)=>{const e=document.implementation.createDocument(h.SSML,"speak"),{lang:n}=t;n&&e.documentElement.setAttributeNS(h.XML,"lang",n);const s=(o,m,f)=>{if(!o)return;if(o.nodeType===3)return e.createTextNode(o.textContent);if(o.nodeType===4)return e.createCDATASection(o.textContent);if(o.nodeType!==1)return;let r;const l=o.nodeName.toLowerCase();l==="foliate-mark"?(r=e.createElementNS(h.SSML,"mark"),r.setAttribute("name",o.dataset.name)):l==="br"?r=e.createElementNS(h.SSML,"break"):(l==="em"||l==="strong")&&(r=e.createElementNS(h.SSML,"emphasis"));const u=o.lang||o.getAttributeNS(h.XML,"lang");u&&(r||(r=e.createElementNS(h.SSML,"lang")),r.setAttributeNS(h.XML,"lang",u));const g=o.getAttributeNS(h.SSML,"alphabet")||f;if(!r){const c=o.getAttributeNS(h.SSML,"ph");c&&(r=e.createElementNS(h.SSML,"phoneme"),g&&r.setAttribute("alphabet",g),r.setAttribute("ph",c))}r||(r=m);let a=o.firstChild;for(;a;){const c=s(a,r,g);c&&r!==c&&r.append(c),a=a.nextSibling}return r};return s(i.firstChild,e.documentElement,t.alphabet),e},T=(i,t,e)=>{const n=M(i.commonAncestorContainer),s=N(i.commonAncestorContainer),o=A(n,e),m=i.cloneContents(),f=[...t(i,o)],r=[...t(m,o)];for(const[u,g]of r){const a=document.createElement("foliate-mark");a.dataset.name=u,g.insertNode(a)}const l=k(m,{lang:n,alphabet:s});return{entries:f,ssml:l}},L=i=>!i.toString().trim();function*y(i){let t;const e=i.createTreeWalker(i.body,NodeFilter.SHOW_ELEMENT);for(let n=e.nextNode();n;n=e.nextNode()){const s=n.tagName.toLowerCase();E.has(s)&&(t&&(t.setEndBefore(n),L(t)||(yield t)),t=i.createRange(),t.setStart(n,0))}t||(t=i.createRange(),t.setStart(i.body.firstChild??i.body,0)),t.setEndAfter(i.body.lastChild??i.body),L(t)||(yield t)}class C{#t=[];#s;#e=-1;#n;constructor(t,e=n=>n){this.#s=t,this.#n=e}current(){if(this.#t[this.#e])return this.#n(this.#t[this.#e])}first(){if(this.#t[0])return this.#e=0,this.#n(this.#t[0])}prev(){const t=this.#e-1;if(this.#t[t])return this.#e=t,this.#n(this.#t[t])}next(){const t=this.#e+1;if(this.#t[t])return this.#e=t,this.#n(this.#t[t]);for(;;){const{done:e,value:n}=this.#s.next();if(e)break;if(this.#t.push(n),this.#t[t])return this.#e=t,this.#n(this.#t[t])}}find(t){const e=this.#t.findIndex(n=>t(n));if(e>-1)return this.#e=e,this.#n(this.#t[e]);for(;;){const{done:n,value:s}=this.#s.next();if(n)break;if(this.#t.push(s),t(s))return this.#e=this.#t.length-1,this.#n(s)}}}class I{#t;#s;#e;#n=new XMLSerializer;constructor(t,e,n,s){this.doc=t,this.highlight=n,this.#t=new C(y(t),o=>{const{entries:m,ssml:f}=T(o,e,s);return this.#s=new Map(m),[f,o]})}#r(t,e){return e?t.querySelector(`mark[name="${CSS.escape(e)}"`):null}#i(t,e){if(!t)return;if(!e)return this.#n.serializeToString(t);const n=document.implementation.createDocument(h.SSML,"speak");n.documentElement.replaceWith(n.importNode(t.documentElement,!0));let s=e(n)?.previousSibling;for(;s;){const o=s.previousSibling??s.parentNode?.previousSibling;s.parentNode.removeChild(s),s=o}return this.#n.serializeToString(n)}start(){this.#e=null;const[t]=this.#t.first()??[];return t?this.#i(t,e=>this.#r(e,this.#e)):this.next()}resume(){const[t]=this.#t.current()??[];return t?this.#i(t,e=>this.#r(e,this.#e)):this.next()}prev(t){this.#e=null;const[e,n]=this.#t.prev()??[];return t&&n&&this.highlight(n.cloneRange()),this.#i(e)}next(t){this.#e=null;const[e,n]=this.#t.next()??[];return t&&n&&this.highlight(n.cloneRange()),this.#i(e)}from(t){this.#e=null;const[e]=this.#t.find(s=>t.compareBoundaryPoints(Range.END_TO_START,s)<=0);let n;for(const[s,o]of this.#s.entries())if(t.compareBoundaryPoints(Range.START_TO_START,o)<=0){n=s;break}return this.#i(e,s=>this.#r(s,n))}setMark(t){const e=this.#s.get(t);e&&(this.#e=t,this.highlight(e.cloneRange()))}}export{I as TTS};

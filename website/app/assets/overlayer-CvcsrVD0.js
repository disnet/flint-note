const a=A=>document.createElementNS("http://www.w3.org/2000/svg",A);class w{#t=a("svg");#e=new Map;#o=null;constructor(t){this.#o=t,Object.assign(this.#t.style,{position:"absolute",top:"0",left:"0",width:"100%",height:"100%",pointerEvents:"none"})}get element(){return this.#t}get#i(){return/^((?!chrome|android).)*AppleWebKit/i.test(navigator.userAgent)&&!window.chrome&&window.getComputedStyle(this.#o.body).zoom||1}#r(t){const l=t.commonAncestorContainer,c=Array.from(l.querySelectorAll?.("p")||[]);if(c.length===0)return[t];const e=[];return c.forEach(r=>{const o=document.createRange();t.intersectsNode(r)&&(o.selectNodeContents(r),o.compareBoundaryPoints(Range.START_TO_START,t)<0&&o.setStart(t.startContainer,t.startOffset),o.compareBoundaryPoints(Range.END_TO_END,t)>0&&o.setEnd(t.endContainer,t.endOffset),e.push(o))}),e}add(t,l,c,e){this.#e.has(t)&&this.remove(t),typeof l=="function"&&(l=l(this.#t.getRootNode()));const r=this.#i;let o=[];this.#r(l).forEach(h=>{const d=Array.from(h.getClientRects()).map(n=>({left:n.left*r,top:n.top*r,right:n.right*r,bottom:n.bottom*r,width:n.width*r,height:n.height*r}));o=o.concat(d)});const s=c(o,e);this.#t.append(s),this.#e.set(t,{range:l,draw:c,options:e,element:s,rects:o})}remove(t){this.#e.has(t)&&(this.#t.removeChild(this.#e.get(t).element),this.#e.delete(t))}redraw(){for(const t of this.#e.values()){const{range:l,draw:c,options:e,element:r}=t;this.#t.removeChild(r);const o=this.#i;let s=[];this.#r(l).forEach(d=>{const n=Array.from(d.getClientRects()).map(i=>({left:i.left*o,top:i.top*o,right:i.right*o,bottom:i.bottom*o,width:i.width*o,height:i.height*o}));s=s.concat(n)});const h=c(s,e);this.#t.append(h),t.element=h,t.rects=s}}hitTest({x:t,y:l}){const c=Array.from(this.#e.entries());for(let e=c.length-1;e>=0;e--){const[r,o]=c[e];for(const{left:s,top:h,right:d,bottom:n}of o.rects)if(h<=l&&s<=t&&n>l&&d>t)return[r,o.range]}return[]}static underline(t,l={}){const{color:c="red",width:e=2,padding:r=0,writingMode:o}=l,s=a("g");if(s.setAttribute("fill",c),o==="vertical-rl"||o==="vertical-lr")for(const{right:h,top:d,height:n}of t){const i=a("rect");i.setAttribute("x",h-e/2+r),i.setAttribute("y",d),i.setAttribute("height",n),i.setAttribute("width",e),s.append(i)}else for(const{left:h,bottom:d,width:n}of t){const i=a("rect");i.setAttribute("x",h),i.setAttribute("y",d-e/2+r),i.setAttribute("height",e),i.setAttribute("width",n),s.append(i)}return s}static strikethrough(t,l={}){const{color:c="red",width:e=2,writingMode:r}=l,o=a("g");if(o.setAttribute("fill",c),r==="vertical-rl"||r==="vertical-lr")for(const{right:s,left:h,top:d,height:n}of t){const i=a("rect");i.setAttribute("x",(s+h)/2),i.setAttribute("y",d),i.setAttribute("height",n),i.setAttribute("width",e),o.append(i)}else for(const{left:s,top:h,bottom:d,width:n}of t){const i=a("rect");i.setAttribute("x",s),i.setAttribute("y",(h+d)/2),i.setAttribute("height",e),i.setAttribute("width",n),o.append(i)}return o}static squiggly(t,l={}){const{color:c="red",width:e=2,padding:r=0,writingMode:o}=l,s=a("g");s.setAttribute("fill","none"),s.setAttribute("stroke",c),s.setAttribute("stroke-width",e);const h=e*1.5;if(o==="vertical-rl"||o==="vertical-lr")for(const{right:d,top:n,height:i}of t){const u=a("path"),g=Math.round(i/h/1.5),f=i/g,p=Array.from({length:g},(m,b)=>`l${b%2?-h:h} ${f}`).join("");u.setAttribute("d",`M${d-e/2+r} ${n}${p}`),s.append(u)}else for(const{left:d,bottom:n,width:i}of t){const u=a("path"),g=Math.round(i/h/1.5),f=i/g,p=Array.from({length:g},(m,b)=>`l${f} ${b%2?h:-h}`).join("");u.setAttribute("d",`M${d} ${n+e/2+r}${p}`),s.append(u)}return s}static highlight(t,l={}){const{color:c="red",padding:e=0}=l,r=a("g");r.setAttribute("fill",c),r.style.opacity="var(--overlayer-highlight-opacity, .3)",r.style.mixBlendMode="var(--overlayer-highlight-blend-mode, normal)";for(const{left:o,top:s,height:h,width:d}of t){const n=a("rect");n.setAttribute("x",o-e),n.setAttribute("y",s-e),n.setAttribute("height",h+e*2),n.setAttribute("width",d+e*2),r.append(n)}return r}static outline(t,l={}){const{color:c="red",width:e=3,padding:r=0,radius:o=3}=l,s=a("g");s.setAttribute("fill","none"),s.setAttribute("stroke",c),s.setAttribute("stroke-width",e);for(const{left:h,top:d,height:n,width:i}of t){const u=a("rect");u.setAttribute("x",h-r),u.setAttribute("y",d-r),u.setAttribute("height",n+r*2),u.setAttribute("width",i+r*2),u.setAttribute("rx",o),s.append(u)}return s}static copyImage([t],l={}){const{src:c}=l,e=a("image"),{left:r,top:o,height:s,width:h}=t;return e.setAttribute("href",c),e.setAttribute("x",r),e.setAttribute("y",o),e.setAttribute("height",s),e.setAttribute("width",h),e}}export{w as Overlayer};

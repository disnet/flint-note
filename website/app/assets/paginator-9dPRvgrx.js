const L=r=>new Promise(t=>setTimeout(t,r)),z=(r,t,e)=>{let i;return(...s)=>{const n=()=>{i=null,r(...s)};i&&clearTimeout(i),i=setTimeout(n,t)}},A=(r,t,e)=>e*(t-r)+r,B=r=>1-(1-r)*(1-r),I=(r,t,e,i,s)=>new Promise(n=>{let o;const a=h=>{o??=h;const l=Math.min(1,(h-o)/e);s(A(r,t,i(l))),l<1?requestAnimationFrame(a):n()};requestAnimationFrame(a)}),V=r=>{if(!r?.collapsed)return r;const{endOffset:t,endContainer:e}=r;if(e.nodeType===1){const i=e.childNodes[t];return i?.nodeType===1?i:e}if(t+1<e.length)r.setEnd(e,t+1);else if(t>1)r.setStart(e,t-1);else return e.parentNode;return r},v=(r,t,e,i=e)=>{const s=r.createRange();return s.setStart(t,e),s.setEnd(t,i),s},E=(r,t,e,i=0,s=t.nodeValue.length)=>{if(s-i===1)return e(v(r,t,i),v(r,t,s))<0?i:s;const n=Math.floor(i+(s-i)/2),o=e(v(r,t,i,n),v(r,t,n,s));return o<0?E(r,t,e,i,n):o>0?E(r,t,e,n,s):n},{SHOW_ELEMENT:N,SHOW_TEXT:O,SHOW_CDATA_SECTION:F,FILTER_ACCEPT:T,FILTER_REJECT:k,FILTER_SKIP:R}=NodeFilter,D=N|O|F,w=r=>{let t=1/0,e=-1/0,i=1/0,s=-1/0;for(const n of r.getClientRects())i=Math.min(i,n.left),t=Math.min(t,n.top),e=Math.max(e,n.right),s=Math.max(s,n.bottom);return new DOMRect(i,t,e-i,s-t)},M=(r,t,e,i)=>{const s=c=>{const p=c.localName?.toLowerCase();if(p==="script"||p==="style")return k;if(c.nodeType===1){const{left:u,right:g}=i(c.getBoundingClientRect());if(g<t||u>e)return k;if(u>=t&&g<=e)return T}else{if(!c.nodeValue?.trim())return R;const u=r.createRange();u.selectNodeContents(c);const{left:g,right:f}=i(u.getBoundingClientRect());if(f>=t&&g<=e)return T}return R},n=r.createTreeWalker(r.body,D,{acceptNode:s}),o=[];for(let c=n.nextNode();c;c=n.nextNode())o.push(c);const a=o[0]??r.body,h=o[o.length-1]??a,l=a.nodeType===1?0:E(r,a,(c,p)=>{const u=i(w(c)),g=i(w(p));return u.right<t&&g.left>t?0:g.left>t?-1:1}),m=h.nodeType===1?0:E(r,h,(c,p)=>{const u=i(w(c)),g=i(w(p));return u.right<e&&g.left>e?0:g.left>e?-1:1}),d=r.createRange();return d.setStart(a,l),d.setEnd(h,m),d},P=r=>{const t=document.createRange();return t.setStart(r.anchorNode,r.anchorOffset),t.setEnd(r.focusNode,r.focusOffset),t.collapsed},b=(r,t)=>{let e;if(r.startContainer?e=r.cloneRange():r.nodeType&&(e=document.createRange(),e.selectNode(r)),e){const i=e.startContainer.ownerDocument.defaultView.getSelection();i.removeAllRanges(),t===-1?e.collapse(!0):t===1&&e.collapse(),i.addRange(e)}},j=r=>{const{defaultView:t}=r,{writingMode:e,direction:i}=t.getComputedStyle(r.body),s=e==="vertical-rl"||e==="vertical-lr",n=r.body.dir==="rtl"||i==="rtl"||r.documentElement.dir==="rtl";return{vertical:s,rtl:n}},W=r=>{const t=r.defaultView.getComputedStyle(r.body);return t.backgroundColor==="rgba(0, 0, 0, 0)"&&t.backgroundImage==="none"?r.defaultView.getComputedStyle(r.documentElement).background:t.background},$=(r,t)=>Array.from({length:r},()=>{const e=document.createElement("div"),i=document.createElement("div");return e.append(i),i.setAttribute("part",t),e}),x=(r,t)=>{const{style:e}=r;for(const[i,s]of Object.entries(t))e.setProperty(i,s,"important")};class q{#a=new ResizeObserver(()=>this.expand());#o=document.createElement("div");#i=document.createElement("iframe");#h=document.createRange();#e;#s=!1;#c=!1;#t=!0;#n;#r={};constructor({container:t,onExpand:e}){this.container=t,this.onExpand=e,this.#i.setAttribute("part","filter"),this.#o.append(this.#i),Object.assign(this.#o.style,{boxSizing:"content-box",position:"relative",overflow:"hidden",flex:"0 0 auto",width:"100%",height:"100%",display:"flex",justifyContent:"center",alignItems:"center"}),Object.assign(this.#i.style,{overflow:"hidden",border:"0",display:"none",width:"100%",height:"100%"}),this.#i.setAttribute("sandbox","allow-same-origin allow-scripts"),this.#i.setAttribute("scrolling","no")}get element(){return this.#o}get document(){return this.#i.contentDocument}async load(t,e,i){if(typeof t!="string")throw new Error(`${t} is not string`);return new Promise(s=>{this.#i.addEventListener("load",()=>{const n=this.document;e?.(n),this.#i.style.display="block";const{vertical:o,rtl:a}=j(n);this.docBackground=W(n),n.body.style.background="none";const h=this.docBackground;this.#i.style.display="none",this.#s=o,this.#c=a,this.#h.selectNodeContents(n.body);const l=i?.({vertical:o,rtl:a,background:h});this.#i.style.display="block",this.render(l),this.#a.observe(n.body),n.fonts.ready.then(()=>this.expand()),s()},{once:!0}),this.#i.src=t})}render(t){!t||!this.document||(this.#t=t.flow!=="scrolled",this.#r=t,this.#t?this.columnize(t):this.scrolled(t))}scrolled({margin:t,gap:e,columnWidth:i}){const s=this.#s,n=this.document;x(n.documentElement,{"box-sizing":"border-box",padding:s?`${t*1.5}px ${e}px`:`0 ${e}px`,"column-width":"auto",height:"auto",width:"auto"}),x(n.body,{[s?"max-height":"max-width"]:`${i}px`,margin:"auto"}),this.setImageSize(),this.expand()}columnize({width:t,height:e,margin:i,gap:s,columnWidth:n}){const o=this.#s;this.#n=o?e:t;const a=this.document;x(a.documentElement,{"box-sizing":"border-box","column-width":`${Math.trunc(n)}px`,"column-gap":o?`${i}px`:`${s}px`,"column-fill":"auto",...o?{width:`${t}px`}:{height:`${e}px`},padding:o?`${i/2}px ${s}px`:`0 ${s/2}px`,overflow:"hidden","overflow-wrap":"break-word",position:"static",border:"0",margin:"0","max-height":"none","max-width":"none","min-height":"none","min-width":"none","-webkit-line-box-contain":"block glyphs replaced"}),x(a.body,{"max-height":"none","max-width":"none",margin:"0"}),this.setImageSize(),this.expand()}setImageSize(){const{width:t,height:e,margin:i}=this.#r,s=this.#s,n=this.document;for(const o of n.body.querySelectorAll("img, svg, video")){const{maxHeight:a,maxWidth:h}=n.defaultView.getComputedStyle(o);x(o,{"max-height":s?a!=="none"&&a!=="0px"?a:"100%":`${e-i*2}px`,"max-width":s?`${t-i*2}px`:h!=="none"&&h!=="0px"?h:"100%","object-fit":"contain","page-break-inside":"avoid","break-inside":"avoid","box-sizing":"border-box"})}}expand(){const{documentElement:t}=this.document;if(this.#t){const e=this.#s?"height":"width",i=this.#s?"width":"height",s=this.#h.getBoundingClientRect(),n=t.getBoundingClientRect(),a=(this.#s?0:this.#c?n.right-s.right:s.left-n.left)+s[e],l=Math.ceil(a/this.#n)*this.#n;this.#o.style.padding="0",this.#i.style[e]=`${l}px`,this.#o.style[e]=`${l+this.#n*2}px`,this.#i.style[i]="100%",this.#o.style[i]="100%",t.style[e]=`${this.#n}px`,this.#e&&(this.#e.element.style.margin="0",this.#e.element.style.left=this.#s?"0":`${this.#n}px`,this.#e.element.style.top=this.#s?`${this.#n}px`:"0",this.#e.element.style[e]=`${l}px`,this.#e.redraw())}else{const e=this.#s?"width":"height",i=this.#s?"height":"width",n=t.getBoundingClientRect()[e],{margin:o,gap:a}=this.#r,h=this.#s?`0 ${a}px`:`${o}px 0`;this.#o.style.padding=h,this.#i.style[e]=`${n}px`,this.#o.style[e]=`${n}px`,this.#i.style[i]="100%",this.#o.style[i]="100%",this.#e&&(this.#e.element.style.margin=h,this.#e.element.style.left="0",this.#e.element.style.top="0",this.#e.element.style[e]=`${n}px`,this.#e.redraw())}this.onExpand()}set overlayer(t){this.#e=t,this.#o.append(t.element)}get overlayer(){return this.#e}destroy(){this.document&&this.#a.unobserve(this.document.body)}}class H extends HTMLElement{static observedAttributes=["flow","gap","margin","max-inline-size","max-block-size","max-column-count"];#a=this.attachShadow({mode:"closed"});#o=new ResizeObserver(()=>this.render());#i;#h;#e;#s;#c;#t;#n=!1;#r=!1;#g=0;#d=-1;#l=0;#E=!1;#x=!1;#T;#k=new WeakMap;#R=matchMedia("(prefers-color-scheme: dark)");#S;#m;#v;#C;#M;constructor(){super(),this.#a.innerHTML=`<style>
        :host {
            display: block;
            container-type: size;
        }
        :host, #top {
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        #top {
            --_gap: 7%;
            --_margin: 48px;
            --_max-inline-size: 720px;
            --_max-block-size: 1440px;
            --_max-column-count: 2;
            --_max-column-count-portrait: 1;
            --_max-column-count-spread: var(--_max-column-count);
            --_half-gap: calc(var(--_gap) / 2);
            --_max-width: calc(var(--_max-inline-size) * var(--_max-column-count-spread));
            --_max-height: var(--_max-block-size);
            display: grid;
            grid-template-columns:
                minmax(var(--_half-gap), 1fr)
                var(--_half-gap)
                minmax(0, calc(var(--_max-width) - var(--_gap)))
                var(--_half-gap)
                minmax(var(--_half-gap), 1fr);
            grid-template-rows:
                minmax(var(--_margin), 1fr)
                minmax(0, var(--_max-height))
                minmax(var(--_margin), 1fr);
            &.vertical {
                --_max-column-count-spread: var(--_max-column-count-portrait);
                --_max-width: var(--_max-block-size);
                --_max-height: calc(var(--_max-inline-size) * var(--_max-column-count-spread));
            }
            @container (orientation: portrait) {
                & {
                    --_max-column-count-spread: var(--_max-column-count-portrait);
                }
                &.vertical {
                    --_max-column-count-spread: var(--_max-column-count);
                }
            }
        }
        #background {
            grid-column: 1 / -1;
            grid-row: 1 / -1;
        }
        #container {
            grid-column: 2 / 5;
            grid-row: 2;
            overflow: hidden;
        }
        :host([flow="scrolled"]) #container {
            grid-column: 1 / -1;
            grid-row: 1 / -1;
            overflow: auto;
        }
        #header {
            grid-column: 3 / 4;
            grid-row: 1;
        }
        #footer {
            grid-column: 3 / 4;
            grid-row: 3;
            align-self: end;
        }
        #header, #footer {
            display: grid;
            height: var(--_margin);
        }
        :is(#header, #footer) > * {
            display: flex;
            align-items: center;
            min-width: 0;
        }
        :is(#header, #footer) > * > * {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            text-align: center;
            font-size: .75em;
            opacity: .6;
        }
        </style>
        <div id="top">
            <div id="background" part="filter"></div>
            <div id="header"></div>
            <div id="container" part="container"></div>
            <div id="footer"></div>
        </div>
        `,this.#i=this.#a.getElementById("top"),this.#h=this.#a.getElementById("background"),this.#e=this.#a.getElementById("container"),this.#s=this.#a.getElementById("header"),this.#c=this.#a.getElementById("footer"),this.#o.observe(this.#e),this.#e.addEventListener("scroll",()=>this.dispatchEvent(new Event("scroll"))),this.#e.addEventListener("scroll",z(()=>{this.scrolled&&(this.#E?this.#E=!1:this.#b("scroll"))},250));const t={passive:!1};this.addEventListener("touchstart",this.#$.bind(this),t),this.addEventListener("touchmove",this.#L.bind(this),t),this.addEventListener("touchend",this.#A.bind(this)),this.addEventListener("load",({detail:{doc:i}})=>{i.addEventListener("touchstart",this.#$.bind(this),t),i.addEventListener("touchmove",this.#L.bind(this),t),i.addEventListener("touchend",this.#A.bind(this))}),this.addEventListener("relocate",({detail:i})=>{i.reason==="selection"?b(this.#l,0):i.reason==="navigation"&&(this.#l===1?b(i.range,1):typeof this.#l=="number"?b(i.range,-1):b(this.#l,-1))});const e=z((i,s)=>{if(!s.rangeCount)return;const n=s.getRangeAt(0),o=P(s);o&&n.compareBoundaryPoints(Range.START_TO_START,i)<0?this.prev():!o&&n.compareBoundaryPoints(Range.END_TO_END,i)>0&&this.next()},700);this.addEventListener("load",({detail:{doc:i}})=>{let s=!1;i.addEventListener("pointerdown",()=>s=!0),i.addEventListener("pointerup",()=>s=!1);let n=!1;i.addEventListener("keydown",()=>n=!0),i.addEventListener("keyup",()=>n=!1),i.addEventListener("selectionchange",()=>{if(this.scrolled)return;const o=this.#M;if(!o)return;const a=i.getSelection();if(a.rangeCount){if(s&&a.type==="Range")e(o,a);else if(n){const h=a.getRangeAt(0).cloneRange();P(a)||h.collapse(),this.#y(h)}}}),i.addEventListener("focusin",o=>this.scrolled?null:requestAnimationFrame(()=>this.#y(o.target)))}),this.#S=()=>{this.#t&&this.#_(this.#t.docBackground,this.columnCount)},this.#R.addEventListener("change",this.#S)}attributeChangedCallback(t,e,i){switch(t){case"flow":this.render();break;case"gap":case"margin":case"max-block-size":case"max-column-count":this.#i.style.setProperty("--_"+t,i),this.render();break;case"max-inline-size":this.#i.style.setProperty("--_"+t,i),this.render();break}}open(t){this.bookDir=t.dir,this.sections=t.sections,t.transformTarget?.addEventListener("data",({detail:e})=>{if(e.type!=="text/css")return;const i=innerWidth,s=innerHeight;e.data=Promise.resolve(e.data).then(n=>n.replace(/(?<=[{\s;])-epub-/gi,"").replace(/(\d*\.?\d+)vw/gi,(o,a)=>parseFloat(a)*i/100+"px").replace(/(\d*\.?\d+)vh/gi,(o,a)=>parseFloat(a)*s/100+"px").replace(/page-break-(after|before|inside)\s*:/gi,(o,a)=>`-webkit-column-break-${a}:`).replace(/break-(after|before|inside)\s*:\s*(avoid-)?page/gi,(o,a,h)=>`break-${a}: ${h??""}column`))})}#N(){return this.#t&&(this.#t.destroy(),this.#e.removeChild(this.#t.element)),this.#t=new q({container:this,onExpand:()=>this.#y(this.#l)}),this.#e.append(this.#t.element),this.#t}#_(t,e){const i=this.#t?.document;if(!i)return;const n=i.defaultView.getComputedStyle(i.documentElement).getPropertyValue("--theme-bg-color");if(t&&n){const o=t.split(/\s(?=(?:url|rgb|hsl|#[0-9a-fA-F]{3,6}))/);o[0]=n,t=o.join(" ")}/cover.*fixed|fixed.*cover/.test(t)&&(t=t.replace("cover","auto 100%").replace("fixed","")),this.#h.innerHTML="",this.#h.style.display="grid",this.#h.style.gridTemplateColumns=`repeat(${e}, 1fr)`;for(let o=0;o<e;o++){const a=document.createElement("div");a.style.background=t,a.style.width="100%",a.style.height="100%",this.#h.appendChild(a)}}#P({vertical:t,rtl:e,background:i}){this.#n=t,this.#r=e,this.#i.classList.toggle("vertical",t);const{width:s,height:n}=this.#e.getBoundingClientRect(),o=t?n:s,a=getComputedStyle(this.#i),h=parseFloat(a.getPropertyValue("--_max-inline-size")),l=parseInt(a.getPropertyValue("--_max-column-count-spread")),m=parseFloat(a.getPropertyValue("--_margin"));this.#g=m;const d=parseFloat(a.getPropertyValue("--_gap"))/100,c=-d/(d-1)*o,p=this.getAttribute("flow");if(p==="scrolled"){this.setAttribute("dir",t?"rtl":"ltr"),this.#i.style.padding="0";const y=h;return this.heads=null,this.feet=null,this.#s.replaceChildren(),this.#c.replaceChildren(),{flow:p,margin:m,gap:c,columnWidth:y}}const u=Math.min(l,Math.ceil(o/h)),g=t?o/u-m:o/u-c;this.setAttribute("dir",e?"rtl":"ltr"),this.columnCount=u,this.#_(i,this.columnCount);const f=t?Math.min(2,Math.ceil(s/h)):u,S={gridTemplateColumns:`repeat(${f}, 1fr)`,gap:`${c}px`,direction:this.bookDir==="rtl"?"rtl":"ltr"};Object.assign(this.#s.style,S),Object.assign(this.#c.style,S);const C=$(f,"head"),_=$(f,"foot");return this.heads=C.map(y=>y.children[0]),this.feet=_.map(y=>y.children[0]),this.#s.replaceChildren(...C),this.#c.replaceChildren(..._),{height:n,width:s,margin:m,gap:c,columnWidth:g}}render(){this.#t&&(this.#t.render(this.#P({vertical:this.#n,rtl:this.#r})),this.#y(this.#l))}get scrolled(){return this.getAttribute("flow")==="scrolled"}get scrollProp(){const{scrolled:t}=this;return this.#n?t?"scrollLeft":"scrollTop":t?"scrollTop":"scrollLeft"}get sideProp(){const{scrolled:t}=this;return this.#n?t?"width":"height":t?"height":"width"}get size(){return this.#e.getBoundingClientRect()[this.sideProp]}get viewSize(){return this.#t.element.getBoundingClientRect()[this.sideProp]}get start(){return Math.abs(this.#e[this.scrollProp])}get end(){return this.start+this.size}get page(){return Math.floor((this.start+this.end)/2/this.size)}get pages(){return Math.round(this.viewSize/this.size)}get containerPosition(){return this.#e[this.scrollProp]}set containerPosition(t){this.#e[this.scrollProp]=t}scrollBy(t,e){const i=this.#n?e:t,[s,n,o]=this.#m,a=this.#r,h=a?s-o:s-n,l=a?s+n:s+o;this.containerPosition=Math.max(h,Math.min(l,this.containerPosition+i))}snap(t,e){const i=this.#n?e:t,[s,n,o]=this.#m,{start:a,end:h,pages:l,size:m}=this,d=Math.abs(s)-n,c=Math.abs(s)+o,p=i*(this.#r?-m:m),u=Math.floor(Math.max(d,Math.min(c,(a+h)/2+(isNaN(p)?0:p)))/m);this.#f(u,"snap").then(()=>{const g=u<=0?-1:u>=l-1?1:null;if(g)return this.#z({index:this.#u(g),anchor:g<0?()=>1:()=>0})})}#$(t){const e=t.changedTouches[0];this.#v={x:e?.screenX,y:e?.screenY,t:t.timeStamp,vx:0,xy:0}}#L(t){const e=this.#v;if(e.pinched||(e.pinched=globalThis.visualViewport.scale>1,this.scrolled||e.pinched))return;if(t.touches.length>1){this.#C&&t.preventDefault();return}const s=this.#t?.document?.getSelection();if(s&&s.rangeCount>0&&!s.isCollapsed)return;t.preventDefault();const n=t.changedTouches[0],o=n.screenX,a=n.screenY,h=e.x-o,l=e.y-a,m=t.timeStamp-e.t;e.x=o,e.y=a,e.t=t.timeStamp,e.vx=h/m,e.vy=l/m,this.#C=!0,Math.abs(h)>=Math.abs(l)?this.scrollBy(h,0):Math.abs(l)>Math.abs(h)&&this.scrollBy(0,l)}#A(){this.#C=!1,!this.scrolled&&requestAnimationFrame(()=>{globalThis.visualViewport.scale===1&&this.snap(this.#v.vx,this.#v.vy)})}#w(){if(this.scrolled){const e=this.viewSize,i=this.#g;return this.#n?({left:s,right:n})=>({left:e-n-i,right:e-s-i}):({top:s,bottom:n})=>({left:s+i,right:n+i})}const t=this.pages*this.size;return this.#r?({left:e,right:i})=>({left:t-i,right:t-e}):this.#n?({top:e,bottom:i})=>({left:e,right:i}):e=>e}async#O(t,e){if(this.scrolled){const s=this.#w()(t).left-this.#g;return this.#p(s,e)}const i=this.#w()(t).left;return this.#f(Math.floor(i/this.size)+(this.#r?-1:1),e)}async#p(t,e,i){const{size:s}=this;if(this.containerPosition===t){this.#m=[t,this.atStart?0:s,this.atEnd?0:s],this.#b(e);return}if(this.scrolled&&this.#n&&(t=-t),(e==="snap"||i)&&this.hasAttribute("animated"))return I(this.containerPosition,t,300,B,n=>this.containerPosition=n).then(()=>{this.#m=[t,this.atStart?0:s,this.atEnd?0:s],this.#b(e)});this.containerPosition=t,this.#m=[t,this.atStart?0:s,this.atEnd?0:s],this.#b(e)}async#f(t,e,i){const s=this.size*(this.#r?-t:t);return this.#p(s,e,i)}async scrollToAnchor(t,e){return this.#y(t,e?"selection":"navigation")}async#y(t,e="anchor"){this.#l=t;const i=V(t)?.getClientRects?.();if(i){const a=Array.from(i).find(h=>h.width>0&&h.height>0)||i[0];if(!a)return;await this.#O(a,e);return}if(this.scrolled){await this.#p(t*this.viewSize,e);return}const{pages:s}=this;if(!s)return;const n=s-2,o=Math.round(t*(n-1));await this.#f(o+1,e)}#F(){if(this.scrolled)return M(this.#t.document,this.start+this.#g,this.end-this.#g,this.#w());const t=this.#r?-this.size:this.size;return M(this.#t.document,this.start-t,this.end-t,this.#w())}#b(t){const e=this.#F();this.#M=e,t!=="selection"&&t!=="navigation"&&t!=="anchor"?this.#l=e:this.#E=!0;const i=this.#d,s={reason:t,range:e,index:i};if(this.scrolled)s.fraction=this.start/this.viewSize;else if(this.pages>0){const{page:n,pages:o}=this;this.#s.style.visibility=n>1?"visible":"hidden",s.fraction=(n-1)/(o-2),s.size=1/(o-2)}this.dispatchEvent(new CustomEvent("relocate",{detail:s}))}async#B(t){const{index:e,src:i,anchor:s,onLoad:n,select:o}=await t;this.#d=e;const a=this.#t?.document?.hasFocus();if(i){const h=this.#N(),l=d=>{if(d.head){const c=d.createElement("style");d.head.prepend(c);const p=d.createElement("style");d.head.append(p),this.#k.set(d,[c,p])}n?.({doc:d,index:e})},m=this.#P.bind(this);await h.load(i,l,m),this.dispatchEvent(new CustomEvent("create-overlayer",{detail:{doc:h.document,index:e,attach:d=>h.overlayer=d}})),this.#t=h}await this.scrollToAnchor((typeof s=="function"?s(this.#t.document):s)??0,o),a&&this.focusView()}#I(t){return t>=0&&t<=this.sections.length-1}async#z({index:t,anchor:e,select:i}){if(t===this.#d)await this.#B({index:t,anchor:e,select:i});else{const s=this.#d,n=o=>{this.sections[s]?.unload?.(),this.setStyles(this.#T),this.dispatchEvent(new CustomEvent("load",{detail:o}))};await this.#B(Promise.resolve(this.sections[t].load()).then(o=>({index:t,src:o,anchor:e,onLoad:n,select:i})).catch(o=>(console.warn(o),console.warn(new Error(`Failed to load section ${t}`)),{})))}}async goTo(t){if(this.#x)return;const e=await t;if(this.#I(e.index))return this.#z(e)}#D(t){if(!this.#t)return!0;if(this.scrolled)return this.start>0?this.#p(Math.max(0,this.start-(t??this.size)),null,!0):!this.atStart;if(this.atStart)return;const e=this.page-1;return this.#f(e,"page",!0).then(()=>e<=0)}#j(t){if(!this.#t)return!0;if(this.scrolled)return this.viewSize-this.end>2?this.#p(Math.min(this.viewSize,t?this.start+t:this.end),null,!0):!this.atEnd;if(this.atEnd)return;const e=this.page+1,i=this.pages;return this.#f(e,"page",!0).then(()=>e>=i-1)}get atStart(){return this.#u(-1)==null&&this.page<=1}get atEnd(){return this.#u(1)==null&&this.page>=this.pages-2}#u(t){for(let e=this.#d+t;this.#I(e);e+=t)if(this.sections[e]?.linear!=="no")return e}async#V(t,e){if(this.#x)return;this.#x=!0;const i=t===-1,s=await(i?this.#D(e):this.#j(e));s&&await this.#z({index:this.#u(t),anchor:i?()=>1:()=>0}),(s||!this.hasAttribute("animated"))&&await L(100),this.#x=!1}async prev(t){return await this.#V(-1,t)}async next(t){return await this.#V(1,t)}prevSection(){return this.goTo({index:this.#u(-1)})}nextSection(){return this.goTo({index:this.#u(1)})}firstSection(){const t=this.sections.findIndex(e=>e.linear!=="no");return this.goTo({index:t})}lastSection(){const t=this.sections.findLastIndex(e=>e.linear!=="no");return this.goTo({index:t})}getContents(){return this.#t?[{index:this.#d,overlayer:this.#t.overlayer,doc:this.#t.document}]:[]}setStyles(t){this.#T=t;const e=this.#k.get(this.#t?.document);if(!e)return;const[i,s]=e;if(Array.isArray(t)){const[n,o]=t;i.textContent=n,s.textContent=o}else s.textContent=t;requestAnimationFrame(()=>{this.#_(this.#t.docBackground,this.columnCount)}),this.#t?.document?.fonts?.ready?.then(()=>this.#t.expand())}focusView(){this.#t.document.defaultView.focus()}destroy(){this.#o.unobserve(this),this.#t.destroy(),this.#t=null,this.sections[this.#d]?.unload?.(),this.#R.removeEventListener("change",this.#S)}}customElements.define("foliate-paginator",H);export{H as Paginator};
